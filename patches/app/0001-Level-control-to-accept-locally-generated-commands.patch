From 9f40663d2f99918c6fda5f14088bd74804566e8a Mon Sep 17 00:00:00 2001
From: Alexei Chetroi <Alexei.Chetroi@outlook.com>
Date: Wed, 8 Jan 2025 17:31:51 -0500
Subject: [PATCH] Syncup patch for the level control

---
 .../plugin/level-control/level-control.c      | 32 +++++++++++++++----
 1 file changed, 25 insertions(+), 7 deletions(-)

diff --git a/protocol/zigbee/app/framework/plugin/level-control/level-control.c b/protocol/zigbee/app/framework/plugin/level-control/level-control.c
index 9cef92991..5956594cf 100644
--- a/protocol/zigbee/app/framework/plugin/level-control/level-control.c
+++ b/protocol/zigbee/app/framework/plugin/level-control/level-control.c
@@ -229,6 +229,7 @@ void emberAfLevelControlClusterServerTickCallback(uint8_t endpoint)
 
   // Are we at the requested level?
   if (currentLevel == state->moveToLevel) {
+    writeRemainingTime(endpoint, 0);
     if (state->commandId == ZCL_MOVE_TO_LEVEL_WITH_ON_OFF_COMMAND_ID
         || state->commandId == ZCL_MOVE_WITH_ON_OFF_COMMAND_ID
         || state->commandId == ZCL_STEP_WITH_ON_OFF_COMMAND_ID) {
@@ -262,7 +263,6 @@ void emberAfLevelControlClusterServerTickCallback(uint8_t endpoint)
         }
       }
     }
-    writeRemainingTime(endpoint, 0);
   } else {
     writeRemainingTime(endpoint,
                        state->transitionTimeMs - state->elapsedTimeMs);
@@ -550,7 +550,14 @@ static void moveToLevelHandler(uint8_t commandId,
                                uint8_t optionOverride,
                                uint16_t storedLevel)
 {
-  uint8_t endpoint = emberAfCurrentEndpoint();
+  bool sendResponse = true;
+  uint8_t endpoint;
+  if (emberAfCurrentCommand() == NULL) {
+      endpoint = emberAfPrimaryEndpoint();
+      sendResponse = false;
+  } else {
+      endpoint = emberAfCurrentEndpoint();
+  }
   EmberAfLevelControlState *state = getState(endpoint);
   EmberAfStatus status;
   uint8_t currentLevel;
@@ -670,7 +677,8 @@ static void moveToLevelHandler(uint8_t commandId,
 #endif
 
   send_default_response:
-  if (emberAfCurrentCommand()->apsFrame->clusterId
+  if (sendResponse
+      && emberAfCurrentCommand()->apsFrame->clusterId
       == ZCL_LEVEL_CONTROL_CLUSTER_ID) {
     emberAfSendImmediateDefaultResponse(status);
   }
@@ -678,7 +686,14 @@ static void moveToLevelHandler(uint8_t commandId,
 
 static void moveHandler(uint8_t commandId, uint8_t moveMode, uint8_t rate, uint8_t optionMask, uint8_t optionOverride)
 {
-  uint8_t endpoint = emberAfCurrentEndpoint();
+  bool sendResponse = true;
+  uint8_t endpoint;
+  if (emberAfCurrentCommand() == NULL) {
+      endpoint = emberAfPrimaryEndpoint();
+      sendResponse = false;
+  } else {
+      endpoint = emberAfCurrentEndpoint();
+  }
   EmberAfLevelControlState *state = getState(endpoint);
   EmberAfStatus status;
   uint8_t currentLevel;
@@ -781,7 +796,7 @@ static void moveHandler(uint8_t commandId, uint8_t moveMode, uint8_t rate, uint8
   status = EMBER_ZCL_STATUS_SUCCESS;
 
   send_default_response:
-  emberAfSendImmediateDefaultResponse(status);
+  if (sendResponse) emberAfSendImmediateDefaultResponse(status);
 }
 
 static void stepHandler(uint8_t commandId,
@@ -984,11 +999,14 @@ void emberAfOnOffClusterLevelControlEffectCallback(uint8_t endpoint,
 
   if (newValue) {
     // If newValue is ZCL_ON_COMMAND_ID...
-    // "Set CurrentLevel to minimum level allowed for the device."
+    // "Set CurrentLevel to minimum level allowed for the device",
+    // unless we just make it instantaneous, depending on OnOff transition time
+    bool instanteneous = currentOnOffTransitionTime == 0x000
+                         || currentOnOffTransitionTime == 0xFFFF;
     status = emberAfWriteServerAttribute(endpoint,
                                          ZCL_LEVEL_CONTROL_CLUSTER_ID,
                                          ZCL_CURRENT_LEVEL_ATTRIBUTE_ID,
-                                         (uint8_t *)&minimumLevelAllowedForTheDevice,
+                                         (uint8_t *) (instanteneous) ? &resolvedLevel : &minimumLevelAllowedForTheDevice,
                                          ZCL_INT8U_ATTRIBUTE_TYPE);
     if (status != EMBER_ZCL_STATUS_SUCCESS) {
       emberAfLevelControlClusterPrintln("ERR: reading current level %x", status);
-- 
2.47.1.windows.1

